<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - Fletes HN</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <a href="index.html" style="text-decoration: none; color: inherit;">
                    <h1>üöö Fletes HN</h1>
                </a>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="perfil-detalle">
            <button class="btn-back" onclick="window.history.back()">‚Üê Volver</button>
            
            <div class="perfil-header">
                <img id="perfil-foto" src="" alt="Foto del transportista" class="perfil-foto-grande">
                <div class="perfil-info">
                    <h2 id="perfil-nombre"></h2>
                    <div class="rating-grande">
                        <span class="estrellas" id="perfil-estrellas"></span>
                        <span id="perfil-rating"></span>
                        <span class="viajes-count" id="perfil-viajes"></span>
                    </div>
                    <div class="perfil-tags">
                        <span class="tag" id="perfil-zona"></span>
                        <span class="tag" id="perfil-vehiculo"></span>
                        <span class="tag tag-distancia" id="perfil-distancia" style="display: none;">üìç Calculando...</span>
                    </div>
                </div>
            </div>

            <div class="perfil-detalles">
                <div class="detalle-seccion">
                    <h3>üìã Sobre m√≠</h3>
                    <p id="perfil-descripcion"></p>
                </div>

                <div class="detalle-seccion">
                    <h3>üöõ Veh√≠culo</h3>
                    <div class="vehiculo-info">
                        <p><strong>Tipo:</strong> <span id="perfil-vehiculo-tipo"></span></p>
                        <p><strong>Capacidad:</strong> <span id="perfil-capacidad"></span></p>
                        <p><strong>Zonas de servicio:</strong> <span id="perfil-zonas"></span></p>
                    </div>
                </div>

                <div class="detalle-seccion">
                    <h3>üí¨ Comentarios de clientes</h3>
                    <div id="perfil-comentarios" class="comentarios-lista">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>

            <div class="perfil-acciones">
                <button class="btn-primary btn-large" id="btn-solicitar" onclick="irASolicitud()" disabled style="opacity: 0.5; cursor: not-allowed;">
                    üì¶ Solicitar Viaje
                </button>
                <button class="btn-secondary btn-large" onclick="abrirChat()">
                    üí¨ Iniciar Chat
                </button>
            </div>
        </div>
    </main>

    <!-- Modal de Chat Conversacional -->
    <div id="modal-chat" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 650px; height: 80vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <img id="chat-foto" src="" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #2563eb;" alt="">
                    <div>
                        <h3 style="margin: 0; font-size: 1.2rem;" id="chat-nombre-titulo"></h3>
                        <span style="font-size: 0.85rem; color: #10b981;">‚óè En l√≠nea</span>
                    </div>
                </div>
                <span class="modal-close" onclick="cerrarChat()" style="font-size: 2rem; cursor: pointer; color: #6b7280;">&times;</span>
            </div>
            
            <!-- √Årea de mensajes -->
            <div id="chat-mensajes" style="flex: 1; overflow-y: auto; padding: 1.5rem 0; display: flex; flex-direction: column; gap: 1rem;">
                <!-- Los mensajes se agregan aqu√≠ din√°micamente -->
            </div>
            
            <!-- Input de mensaje -->
            <div id="chat-input-container" style="border-top: 2px solid #e5e7eb; padding-top: 1rem;">
                <div style="display: flex; gap: 0.75rem;">
                    <input 
                        type="text" 
                        id="chat-input" 
                        placeholder="Escribe tu mensaje..."
                        style="flex: 1; padding: 0.9rem; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem;"
                        onkeypress="if(event.key === 'Enter') enviarMensaje()">
                    <button onclick="enviarMensaje()" style="padding: 0.9rem 1.5rem; background: linear-gradient(135deg, #2563eb, #1e40af); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                        Enviar
                    </button>
                </div>
            </div>

            <!-- Opciones de respuesta r√°pida -->
            <div id="opciones-rapidas" style="display: none; padding-top: 1rem; gap: 0.5rem; flex-wrap: wrap;">
                <!-- Se agregan din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Solicitud (ahora p√°gina separada) -->
        <div class="modal-content modal-viaje">
            <span class="modal-close" onclick="cerrarModal()">&times;</span>
            <h3>üì¶ Solicitar Viaje</h3>
            
            <div class="viaje-layout">
                <!-- MAPA PRINCIPAL -->
                <div class="mapa-principal">
                    <div id="mapa-seleccion"></div>
                    <div class="mapa-instrucciones" id="instrucciones-mapa">
                        <div class="instruccion-card">
                            <span class="instruccion-numero">1</span>
                            <p><strong>Selecciona tu origen</strong><br>
                            Usa el bot√≥n de ubicaci√≥n o haz click en el mapa</p>
                        </div>
                    </div>
                    <div class="mapa-leyenda-flotante">
                        <div class="leyenda-item">
                            <span class="marcador-preview verde">A</span>
                            <span>Origen</span>
                        </div>
                        <div class="leyenda-item">
                            <span class="marcador-preview rojo">B</span>
                            <span>Destino</span>
                        </div>
                    </div>
                </div>

                <!-- PANEL LATERAL -->
                <div class="panel-lateral">
                    <form id="form-solicitud">
                        <!-- ORIGEN -->
                        <div class="ubicacion-seccion">
                            <div class="seccion-header">
                                <div class="marcador-icono verde">A</div>
                                <h4>Punto de Origen</h4>
                            </div>
                            
                            <button type="button" class="btn-ubicacion-gps" onclick="obtenerUbicacionActual()">
                                <span class="gps-icono">üìç</span>
                                <span class="gps-texto">Usar mi ubicaci√≥n actual</span>
                            </button>

                            <div class="separador">
                                <span>o</span>
                            </div>

                            <div class="form-group-custom">
                                <input 
                                    type="text" 
                                    id="origen" 
                                    placeholder="üîç Buscar direcci√≥n o haz click en el mapa..." 
                                    autocomplete="off">
                                <div id="sugerencias-origen" class="sugerencias-mejoradas"></div>
                            </div>

                            <div class="ubicacion-seleccionada" id="origen-info" style="display: none;">
                                <span class="check-icon">‚úì</span>
                                <div>
                                    <strong>Origen seleccionado</strong>
                                    <p id="origen-direccion"></p>
                                </div>
                            </div>
                        </div>

                        <!-- DESTINO -->
                        <div class="ubicacion-seccion">
                            <div class="seccion-header">
                                <div class="marcador-icono rojo">B</div>
                                <h4>Punto de Destino</h4>
                            </div>

                            <div class="form-group-custom">
                                <input 
                                    type="text" 
                                    id="destino" 
                                    placeholder="üîç Buscar direcci√≥n o haz click en el mapa..." 
                                    autocomplete="off">
                                <div id="sugerencias-destino" class="sugerencias-mejoradas"></div>
                            </div>

                            <div class="ubicacion-seleccionada" id="destino-info" style="display: none;">
                                <span class="check-icon">‚úì</span>
                                <div>
                                    <strong>Destino seleccionado</strong>
                                    <p id="destino-direccion"></p>
                                </div>
                            </div>
                        </div>

                        <!-- INFO DE RUTA -->
                        <div class="info-ruta" id="info-ruta" style="display: none;">
                            <div class="ruta-stat">
                                <span class="stat-icon">üìè</span>
                                <div>
                                    <small>Distancia</small>
                                    <strong id="distancia-texto">0 km</strong>
                                </div>
                            </div>
                            <div class="ruta-stat">
                                <span class="stat-icon">‚è±Ô∏è</span>
                                <div>
                                    <small>Tiempo estimado</small>
                                    <strong id="tiempo-texto">0 min</strong>
                                </div>
                            </div>
                        </div>

                        <!-- DESCRIPCI√ìN -->
                        <div class="form-group-custom">
                            <label>üì¶ ¬øQu√© necesitas transportar?</label>
                            <textarea 
                                id="descripcion" 
                                placeholder="Ej: Un sof√° de 2 metros, cajas de mudanza, electrodom√©sticos..." 
                                rows="3"
                                required></textarea>
                        </div>

                        <button type="submit" class="btn-confirmar" disabled id="btn-confirmar">
                            <span class="btn-icono">üöö</span>
                            <span>Confirmar Viaje</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Proteger p√°gina
        Auth.protegerPagina();
        
        let transportista;
        let mapaSeleccion;
        let marcadorOrigen;
        let marcadorDestino;
        let coordOrigen = null;
        let coordDestino = null;
        let ubicacionUsuario = null;
        let rutaLinea = null;
        let seleccionandoOrigen = true;

        // Cargar datos del transportista
        const params = new URLSearchParams(window.location.search);
        const id = parseInt(params.get('id'));
        transportista = transportistas.find(t => t.id === id);

        if (transportista) {
            document.getElementById('perfil-foto').src = transportista.foto;
            document.getElementById('perfil-nombre').textContent = transportista.nombre;
            document.getElementById('perfil-estrellas').innerHTML = generarEstrellas(transportista.rating);
            document.getElementById('perfil-rating').textContent = `${transportista.rating} (${transportista.viajes} viajes)`;
            document.getElementById('perfil-viajes').textContent = `${transportista.viajes} viajes completados`;
            document.getElementById('perfil-zona').textContent = `üìç ${transportista.zona}`;
            document.getElementById('perfil-vehiculo').textContent = `üöó ${transportista.vehiculo}`;
            document.getElementById('perfil-descripcion').textContent = transportista.descripcion;
            document.getElementById('perfil-vehiculo-tipo').textContent = transportista.vehiculo;
            document.getElementById('perfil-capacidad').textContent = transportista.capacidad;
            document.getElementById('perfil-zonas').textContent = transportista.zonasServicio.join(', ');

            const comentariosHTML = transportista.comentarios.map(c => `
                <div class="comentario">
                    <div class="comentario-header">
                        <strong>${c.usuario}</strong>
                        <span class="estrellas">${generarEstrellas(c.rating)}</span>
                    </div>
                    <p>${c.texto}</p>
                    <small>${c.fecha}</small>
                </div>
            `).join('');
            document.getElementById('perfil-comentarios').innerHTML = comentariosHTML;
        }

        // Intentar obtener ubicaci√≥n del usuario
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    ubicacionUsuario = [position.coords.latitude, position.coords.longitude];
                    calcularDistanciaTransportista();
                },
                (error) => console.log('No se pudo obtener ubicaci√≥n:', error)
            );
        }

        function calcularDistanciaTransportista() {
            if (!ubicacionUsuario) return;
            const coordTransportista = obtenerCoordenadas(transportista.zona);
            const distancia = calcularDistancia(ubicacionUsuario, coordTransportista);
            const tagDistancia = document.getElementById('perfil-distancia');
            tagDistancia.textContent = `üìç A ${distancia.toFixed(1)} km de ti`;
            tagDistancia.style.display = 'inline-block';
            tagDistancia.style.background = '#dcfce7';
            tagDistancia.style.color = '#166534';
        }

        function calcularDistancia(coord1, coord2) {
            const R = 6371;
            const dLat = (coord2[0] - coord1[0]) * Math.PI / 180;
            const dLon = (coord2[1] - coord1[1]) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(coord1[0] * Math.PI / 180) * Math.cos(coord2[0] * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function generarEstrellas(rating) {
            let estrellas = '';
            for(let i = 1; i <= 5; i++) {
                estrellas += i <= rating ? '‚≠ê' : '‚òÜ';
            }
            return estrellas;
        }

        function solicitarViaje() {
            document.getElementById('modal-solicitud').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            setTimeout(() => inicializarMapaSeleccion(), 100);
        }

        function cerrarModal() {
            document.getElementById('modal-solicitud').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function contactar() {
            alert('üí¨ Funci√≥n de chat en desarrollo.\n\nEn la versi√≥n final podr√°s:\n- Chatear en tiempo real\n- Llamar directamente\n- Enviar ubicaci√≥n');
        }

        // ============================================
        // SISTEMA DE CHAT CONVERSACIONAL
        // ============================================
        
        const PRECIO_BASE = 1000;
        const DESCUENTO_MAXIMO = 0.20;
        const PRECIO_MINIMO = PRECIO_BASE * (1 - DESCUENTO_MAXIMO);
        
        let chatMensajes = [];
        let estadoChat = 'inicio'; // inicio, esperando_viaje, cotizando, regateo, finalizado
        let precioAcordado = null;
        let origenViaje = '';
        let destinoViaje = '';

        function abrirChat() {
            document.getElementById('modal-chat').style.display = 'flex';
            document.getElementById('chat-foto').src = transportista.foto;
            document.getElementById('chat-nombre-titulo').textContent = transportista.nombre;
            
            // Mensaje de bienvenida autom√°tico
            setTimeout(() => {
                agregarMensajeBot(`¬°Hola! Soy ${transportista.nombre} üëã\n\n¬øEn qu√© puedo ayudarte hoy?`);
                estadoChat = 'esperando_viaje';
            }, 500);
        }

        function cerrarChat() {
            document.getElementById('modal-chat').style.display = 'none';
            limpiarChat();
        }

        function limpiarChat() {
            chatMensajes = [];
            document.getElementById('chat-mensajes').innerHTML = '';
            document.getElementById('chat-input').value = '';
            estadoChat = 'inicio';
        }

        function agregarMensajeUsuario(texto) {
            const mensajeDiv = document.createElement('div');
            mensajeDiv.style.cssText = 'display: flex; justify-content: flex-end;';
            mensajeDiv.innerHTML = `
                <div style="max-width: 70%; background: #2563eb; color: white; padding: 1rem; border-radius: 12px 12px 0 12px; box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);">
                    ${texto.replace(/\n/g, '<br>')}
                </div>
            `;
            document.getElementById('chat-mensajes').appendChild(mensajeDiv);
            scrollToBottom();
        }

        function agregarMensajeBot(texto, opciones = null) {
            const mensajeDiv = document.createElement('div');
            mensajeDiv.style.cssText = 'display: flex; gap: 1rem;';
            mensajeDiv.innerHTML = `
                <img src="${transportista.foto}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; align-self: flex-start;">
                <div style="max-width: 70%; background: white; padding: 1rem; border-radius: 12px 12px 12px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                    ${texto.replace(/\n/g, '<br>')}
                </div>
            `;
            document.getElementById('chat-mensajes').appendChild(mensajeDiv);
            
            // Agregar opciones r√°pidas si existen
            if (opciones) {
                mostrarOpcionesRapidas(opciones);
            }
            
            scrollToBottom();
        }

        function mostrarOpcionesRapidas(opciones) {
            const opcionesDiv = document.getElementById('opciones-rapidas');
            opcionesDiv.style.display = 'flex';
            opcionesDiv.innerHTML = '';
            
            opciones.forEach(opcion => {
                const btn = document.createElement('button');
                btn.textContent = opcion.texto;
                btn.style.cssText = 'padding: 0.6rem 1.2rem; background: white; border: 2px solid #2563eb; color: #2563eb; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;';
                btn.onmouseover = () => {
                    btn.style.background = '#2563eb';
                    btn.style.color = 'white';
                };
                btn.onmouseout = () => {
                    btn.style.background = 'white';
                    btn.style.color = '#2563eb';
                };
                btn.onclick = () => {
                    opcionesDiv.style.display = 'none';
                    if (opcion.accion) {
                        opcion.accion();
                    }
                };
                opcionesDiv.appendChild(btn);
            });
        }

        function scrollToBottom() {
            const chatMensajes = document.getElementById('chat-mensajes');
            setTimeout(() => {
                chatMensajes.scrollTop = chatMensajes.scrollHeight;
            }, 100);
        }

        function enviarMensaje() {
            const input = document.getElementById('chat-input');
            const texto = input.value.trim();
            
            if (!texto) return;
            
            agregarMensajeUsuario(texto);
            input.value = '';
            
            // Procesar mensaje seg√∫n estado
            setTimeout(() => {
                procesarMensaje(texto.toLowerCase());
            }, 800);
        }

        function procesarMensaje(texto) {
            if (estadoChat === 'esperando_viaje') {
                // Extraer origen y destino del mensaje
                if (texto.includes('de') && (texto.includes('a') || texto.includes('hasta'))) {
                    // Intenta extraer ubicaciones
                    origenViaje = 'tu ubicaci√≥n';
                    destinoViaje = 'el destino';
                    
                    // Responder con cotizaci√≥n
                    setTimeout(() => {
                        agregarMensajeBot(
                            `Perfecto, entiendo que necesitas transportar algo. üì¶\n\nPara tu viaje el precio es de ${PRECIO_BASE.toLocaleString()} LPS.\n\n<strong>Esto incluye:</strong>\n‚úì Carga y descarga\n‚úì Seguro b√°sico\n‚úì Combustible\n\n¬øTe parece bien el precio?`,
                            [
                                { texto: '‚úì S√≠, acepto', accion: () => aceptarPrecioDesdechat() },
                                { texto: 'üí∞ Quiero proponer otro precio', accion: () => iniciarRegateo() }
                            ]
                        );
                        estadoChat = 'cotizando';
                    }, 500);
                } else {
                    agregarMensajeBot('Cu√©ntame, ¬øqu√© necesitas transportar y a d√≥nde? üöö\n\nPor ejemplo: "Necesito mover un sof√° de Choloma a Centro"');
                }
            } else if (estadoChat === 'regateo') {
                // Extraer n√∫mero del mensaje
                const numero = parseInt(texto.match(/\d+/)?.[0]);
                if (numero) {
                    validarRegateo(numero);
                } else {
                    agregarMensajeBot('Por favor dime un precio en n√∫meros. Ejemplo: "900" o "850 lempiras"');
                }
            }
        }

        function aceptarPrecioDesdechat() {
            agregarMensajeUsuario('S√≠, acepto el precio de 1,000 LPS');
            precioAcordado = PRECIO_BASE;
            
            setTimeout(() => {
                agregarMensajeBot(`¬°Excelente! Precio confirmado: ${PRECIO_BASE.toLocaleString()} LPS ‚úÖ\n\nAhora puedes ir a "Solicitar Viaje" para completar los detalles de tu env√≠o.`);
                estadoChat = 'finalizado';
                habilitarBotonSolicitar();
            }, 800);
        }

        function iniciarRegateo() {
            agregarMensajeUsuario('Quiero proponer otro precio');
            
            setTimeout(() => {
                agregarMensajeBot(
                    `Entiendo, puedo considerar hasta un 20% de descuento. üí°\n\nEl precio m√≠nimo ser√≠a ${PRECIO_MINIMO.toLocaleString()} LPS.\n\n¬øCu√°nto puedes pagar?`
                );
                estadoChat = 'regateo';
            }, 800);
        }

        function validarRegateo(oferta) {
            if (oferta >= PRECIO_BASE) {
                precioAcordado = PRECIO_BASE;
                agregarMensajeBot(`Con ${PRECIO_BASE.toLocaleString()} LPS est√° perfecto. ¬°Trato hecho! ü§ù`);
                estadoChat = 'finalizado';
                habilitarBotonSolicitar();
            } else if (oferta >= PRECIO_MINIMO && oferta < PRECIO_BASE) {
                precioAcordado = oferta;
                const descuento = ((PRECIO_BASE - oferta) / PRECIO_BASE * 100).toFixed(0);
                agregarMensajeBot(`¬°Trato hecho! Acepto ${oferta.toLocaleString()} LPS (${descuento}% de descuento). ü§ù\n\nPuedes proceder a solicitar tu viaje.`);
                estadoChat = 'finalizado';
                habilitarBotonSolicitar();
            } else {
                const diferencia = PRECIO_MINIMO - oferta;
                agregarMensajeBot(
                    `Lo siento, ese precio es muy bajo. üòî\n\nMi precio m√≠nimo es ${PRECIO_MINIMO.toLocaleString()} LPS.\n\nTe faltar√≠an ${diferencia.toLocaleString()} LPS m√°s.\n\n¬øPuedes aumentar un poco tu oferta?`
                );
            }
        }

        function habilitarBotonSolicitar() {
            const btn = document.getElementById('btn-solicitar');
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            
            setTimeout(() => {
                alert(`‚úÖ ¬°Cotizaci√≥n confirmada!\n\nPrecio acordado: ${precioAcordado.toLocaleString()} LPS\n\nAhora puedes solicitar tu viaje.`);
                cerrarChat();
            }, 2000);
        }

        function irASolicitud() {
            if (!precioAcordado) {
                alert('‚ö†Ô∏è Primero debes chatear con el transportista y acordar un precio.');
                return;
            }
            
            // Guardar datos para la p√°gina de solicitud
            const datosSolicitud = {
                transportista: transportista,
                precioAcordado: precioAcordado,
                fecha: new Date().toISOString()
            };
            localStorage.setItem('solicitudActual', JSON.stringify(datosSolicitud));
            
            // Redirigir a p√°gina de solicitud
            window.location.href = 'solicitud.html';
        }

        // ============================================
        // FIN SISTEMA DE CHAT
        // ============================================

        function inicializarMapaSeleccion() {
            if (mapaSeleccion) return;

            const centro = ubicacionUsuario || [15.5050, -88.0250];
            mapaSeleccion = L.map('mapa-seleccion').setView(centro, 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(mapaSeleccion);

            if (ubicacionUsuario) {
                L.circleMarker(ubicacionUsuario, {
                    radius: 10,
                    fillColor: '#2563eb',
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(mapaSeleccion).bindPopup('üìç Tu ubicaci√≥n');
            }

            mapaSeleccion.on('click', function(e) {
                const coord = [e.latlng.lat, e.latlng.lng];
                
                if (!coordOrigen) {
                    coordOrigen = coord;
                    colocarMarcadorOrigen(coord);
                    obtenerDireccion(coord, 'origen');
                    actualizarInstrucciones('destino');
                } else if (!coordDestino) {
                    coordDestino = coord;
                    colocarMarcadorDestino(coord);
                    obtenerDireccion(coord, 'destino');
                    actualizarInstrucciones('completo');
                    calcularRuta();
                }
            });
        }

        function colocarMarcadorOrigen(coord) {
            if (marcadorOrigen) mapaSeleccion.removeLayer(marcadorOrigen);
            
            marcadorOrigen = L.marker(coord, {
                icon: L.divIcon({
                    className: 'marcador-custom',
                    html: '<div class="marcador-animado verde"><span>A</span></div>',
                    iconSize: [50, 50],
                    iconAnchor: [25, 50]
                }),
                draggable: true
            }).addTo(mapaSeleccion);

            marcadorOrigen.on('dragend', function(e) {
                const pos = e.target.getLatLng();
                coordOrigen = [pos.lat, pos.lng];
                obtenerDireccion(coordOrigen, 'origen');
                if (coordDestino) calcularRuta();
            });

            document.getElementById('origen-info').style.display = 'flex';
            mapaSeleccion.setView(coord, 15, { animate: true });
        }

        function colocarMarcadorDestino(coord) {
            if (marcadorDestino) mapaSeleccion.removeLayer(marcadorDestino);
            
            marcadorDestino = L.marker(coord, {
                icon: L.divIcon({
                    className: 'marcador-custom',
                    html: '<div class="marcador-animado rojo"><span>B</span></div>',
                    iconSize: [50, 50],
                    iconAnchor: [25, 50]
                }),
                draggable: true
            }).addTo(mapaSeleccion);

            marcadorDestino.on('dragend', function(e) {
                const pos = e.target.getLatLng();
                coordDestino = [pos.lat, pos.lng];
                obtenerDireccion(coordDestino, 'destino');
                calcularRuta();
            });

            document.getElementById('destino-info').style.display = 'flex';
        }

        async function obtenerDireccion(coord, tipo) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${coord[0]}&lon=${coord[1]}&accept-language=es`
                );
                const data = await response.json();
                const direccion = data.display_name;
                document.getElementById(tipo).value = direccion;
                document.getElementById(`${tipo}-direccion`).textContent = direccion;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        let timeoutBusqueda;
        ['origen', 'destino'].forEach(tipo => {
            document.getElementById(tipo).addEventListener('input', function(e) {
                clearTimeout(timeoutBusqueda);
                const query = e.target.value;
                if (query.length < 3) {
                    document.getElementById(`sugerencias-${tipo}`).innerHTML = '';
                    return;
                }
                timeoutBusqueda = setTimeout(() => buscarDireccion(query, tipo), 500);
            });

            document.getElementById(tipo).addEventListener('focus', function() {
                seleccionandoOrigen = (tipo === 'origen');
                actualizarInstrucciones(tipo);
            });
        });

        async function buscarDireccion(query, tipo) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', San Pedro Sula, Honduras')}&limit=5&accept-language=es`
                );
                const resultados = await response.json();
                mostrarSugerenciasMejoradas(resultados, tipo);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function mostrarSugerenciasMejoradas(resultados, tipo) {
            const container = document.getElementById(`sugerencias-${tipo}`);
            
            if (resultados.length === 0) {
                container.innerHTML = '<div class="sin-resultados">No se encontraron resultados</div>';
                return;
            }

            container.innerHTML = resultados.map(r => {
                const icono = obtenerIconoLugar(r.type);
                let distanciaHtml = '';
                
                if (ubicacionUsuario) {
                    const dist = calcularDistancia(ubicacionUsuario, [parseFloat(r.lat), parseFloat(r.lon)]);
                    distanciaHtml = `<span class="sugerencia-distancia">üìç ${dist.toFixed(1)} km</span>`;
                }

                return `
                    <div class="sugerencia-mejorada" onclick='seleccionarDireccion(${r.lat}, ${r.lon}, \`${r.display_name}\`, "${tipo}")'>
                        <div class="sugerencia-icono">${icono}</div>
                        <div class="sugerencia-info">
                            <strong>${r.display_name.split(',')[0]}</strong>
                            <small>${r.display_name}</small>
                            ${distanciaHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function obtenerIconoLugar(tipo) {
            const iconos = {
                'building': 'üè¢',
                'commercial': 'üè™',
                'house': 'üè†',
                'residential': 'üèòÔ∏è',
                'school': 'üè´',
                'hospital': 'üè•',
                'church': '‚õ™',
                'park': 'üå≥',
                'default': 'üìç'
            };
            return iconos[tipo] || iconos.default;
        }

        function seleccionarDireccion(lat, lon, nombre, tipo) {
            const coord = [parseFloat(lat), parseFloat(lon)];
            
            if (tipo === 'origen') {
                coordOrigen = coord;
                colocarMarcadorOrigen(coord);
                document.getElementById('origen').value = nombre;
                document.getElementById('origen-direccion').textContent = nombre;
                document.getElementById('origen-info').style.display = 'flex';
                actualizarInstrucciones('destino');
            } else {
                coordDestino = coord;
                colocarMarcadorDestino(coord);
                document.getElementById('destino').value = nombre;
                document.getElementById('destino-direccion').textContent = nombre;
                document.getElementById('destino-info').style.display = 'flex';
                actualizarInstrucciones('completo');
            }

            document.getElementById(`sugerencias-${tipo}`).innerHTML = '';
            mapaSeleccion.setView(coord, 15, { animate: true });
            
            if (coordOrigen && coordDestino) {
                calcularRuta();
            }
        }

        function obtenerUbicacionActual() {
            if (!navigator.geolocation) {
                alert('Tu navegador no soporta geolocalizaci√≥n');
                return;
            }

            const btn = event.target.closest('.btn-ubicacion-gps');
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = '<span class="gps-icono">‚è≥</span><span class="gps-texto">Obteniendo ubicaci√≥n...</span>';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coord = [position.coords.latitude, position.coords.longitude];
                    coordOrigen = coord;
                    ubicacionUsuario = coord;
                    colocarMarcadorOrigen(coord);
                    obtenerDireccion(coord, 'origen');
                    mapaSeleccion.setView(coord, 15, { animate: true });
                    
                    btn.innerHTML = '<span class="gps-icono">‚úì</span><span class="gps-texto">Ubicaci√≥n obtenida</span>';
                    btn.classList.add('success');
                    
                    setTimeout(() => {
                        btn.innerHTML = textoOriginal;
                        btn.disabled = false;
                        btn.classList.remove('success');
                    }, 2000);
                },
                (error) => {
                    alert('No se pudo obtener tu ubicaci√≥n. Verifica los permisos.');
                    btn.innerHTML = textoOriginal;
                    btn.disabled = false;
                }
            );
        }

        function actualizarInstrucciones(estado) {
            const instrucciones = document.getElementById('instrucciones-mapa');
            
            const mensajes = {
                'origen': '<span class="instruccion-numero">1</span><p><strong>Selecciona tu origen</strong><br>Haz click en el mapa o busca una direcci√≥n</p>',
                'destino': '<span class="instruccion-numero">2</span><p><strong>Selecciona tu destino</strong><br>Haz click en el mapa o busca una direcci√≥n</p>',
                'completo': '<span class="instruccion-numero">‚úì</span><p><strong>¬°Listo!</strong><br>Revisa la ruta y confirma tu viaje</p>'
            };

            instrucciones.querySelector('.instruccion-card').innerHTML = mensajes[estado];
        }

        function calcularRuta() {
            if (!coordOrigen || !coordDestino) return;

            if (rutaLinea) mapaSeleccion.removeLayer(rutaLinea);

            rutaLinea = L.polyline([coordOrigen, coordDestino], {
                color: '#2563eb',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(mapaSeleccion);

            mapaSeleccion.fitBounds(rutaLinea.getBounds(), { padding: [50, 50] });

            const distancia = calcularDistancia(coordOrigen, coordDestino);
            const tiempo = Math.round(distancia * 3);

            document.getElementById('info-ruta').style.display = 'flex';
            document.getElementById('distancia-texto').textContent = `${distancia.toFixed(1)} km`;
            document.getElementById('tiempo-texto').textContent = `${tiempo} min`;
            document.getElementById('btn-confirmar').disabled = false;
        }

        document.getElementById('form-solicitud').addEventListener('submit', function(e) {
            e.preventDefault();

            if (!coordOrigen || !coordDestino) {
                alert('Por favor selecciona origen y destino');
                return;
            }

            const viaje = {
                transportista: transportista,
                origen: document.getElementById('origen').value,
                destino: document.getElementById('destino').value,
                descripcion: document.getElementById('descripcion').value,
                coordOrigen: coordOrigen,
                coordDestino: coordDestino,
                fecha: new Date().toISOString()
            };
            
            localStorage.setItem('viajeActual', JSON.stringify(viaje));
            window.location.href = 'viaje.html';
        });

        window.onclick = function(event) {
            if (event.target == document.getElementById('modal-solicitud')) {
                cerrarModal();
            }
        }
    </script>
</body>
</html>